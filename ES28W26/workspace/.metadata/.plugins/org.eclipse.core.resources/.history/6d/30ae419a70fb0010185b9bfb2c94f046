/*
 * NAME: Soleil Demick
 * COURSE: ES28W26 Lab 3
 * FILE: SolenoidButton.c
 * DESCRIPTION: Activates a solenoid from an external button input.
 *
 * I/O PINS:
 *   PB4 - OUTPUT, CONTROLS TRANSISTOR FOR SOLENOID CONTROL
 */

// Includes
#include "ES28.h"
#include "uart.h"
#include <stdio.h>

// PIN MACROS
#define GPIOBEN (1U<<1)
#define TRANSISTOR_PIN (1U<<4)

int main(void) {
	uart2_init();
	// enable clock access to port B
	RCC->IOPENR |= GPIOBEN;

	// Set transistor pin as output
	GPIOB->MODER &= ~GPIO_MODER_MODE4_Msk;
	GPIOB->MODER |= (GPIO_OUTPUT << GPIO_MODER_MODE4_Pos);

	// variable to control the state of the door latch
	typedef enum {OPEN, CLOSED} latch_t;
	latch_t latch_state = CLOSED;

	uint8_t keypress; // for reading the keyboard

	while (1) {
		// poll keyboard
		keypress = uart2_read();

		// switch latch state on key press
		if ((keypress == 'O' || keypress == 'o') && latch_state == CLOSED) {
			// energize solenoid (open) when O/o is pressed, if not already energized
			latch_state = OPEN;
			GPIOB->ODR |= TRANSISTOR_PIN;
		} else if ((keypress == 'C' || keypress == 'c') && latch_state == OPEN) {
			// de-energize solenoid (closed) when C/c is pressed, if not already de-energized
			latch_state = CLOSED;
			GPIOB->ODR &= ~TRANSISTOR_PIN;
		}
	}
	return 0;
}
